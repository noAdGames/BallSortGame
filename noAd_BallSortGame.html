<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BallSortGame</title>
    <style>
        body { background-color: black; color: white; font-family: Arial, sans-serif; text-align: center; }
        .test-tube-container { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 20px; gap: 10px; }
        .test-tube { width: 70px; height: 182px; position: relative; background-size: cover; background-image: url('test_tube50130.png'); border: 2px solid transparent; cursor: pointer; }
        .ball { width: 36px; height: 36px; position: absolute; left: 50%; transform: translateX(-50%); transition: bottom 0.3s ease; }
        .ball img { width: 100%; height: 100%; border-radius: 50%; }
        .button-container { margin-top: 10px; display: flex; justify-content: center; gap: 10px; }
        .button-container button { background-color: #444; color: white; padding: 10px 20px; border: none; cursor: pointer; transition: all 0.2s ease; }
        .button-container button:hover { background-color: #666; }
        .button-container button:active { transform: scale(0.9); background-color: #888; }
    </style>
</head>
<body>
    <h1>Ball Sort Game</h1>
    <div class="test-tube-container" id="testTubes"></div>

    <div class="button-container">
        <button onclick="undoMove()">1ã¤å‰ã«æˆ»ã‚‹</button>
        <button onclick="retryGame()">æœ€åˆã«æˆ»ã‚‹</button>
        <button onclick="addEmptyTestTube()" id="text"></button>
    </div>
    
    <div class="button-container">
        <button onclick="restartGame()">ä¸¦ã¹æ›¿ãˆã‚‹</button>
    </div>

    <div class="dropdown-container">
        <label>ãƒœãƒ¼ãƒ«:</label>
        <select id="numberSelect" onchange="updateGame()">
            <option value="2">2</option><option value="3">3</option>
            <option value="4" selected>4</option><option value="5">5</option><option value="6">6</option>
        </select>
        <label>ç¨®é¡</label>
    </div>

    <script>
        const ballColors = ['red', 'blue', 'green', 'yellow', 'purple', 'gray'];
        const ballImages = { red: 'red.png', blue: 'blue.png', green: 'green.png', yellow: 'yellow.png', purple: 'purple.png', gray: 'gray.png' };
        let numBalls = 4, testTubes = [], number26 = 4, selectedTube = null, moveHistory = [], numAddTestTube = [];

        function updateGame() {
            number26 = parseInt(document.getElementById('numberSelect').value);
            startGame();
        }

        function startGame() {
            testTubes = [];
            moveHistory = []; // ãƒªã‚»ãƒƒãƒˆæ™‚ã«å±¥æ­´ã‚‚åˆæœŸåŒ–

            let selectBallColors = ballColors.slice(0, number26);
            let exSelectColors = selectBallColors.flatMap(color => Array(4).fill(color));
            shuffleArray(exSelectColors);

            let separateExSelectColors = [];
            for (let i = 0; i < exSelectColors.length; i += 4) {
                separateExSelectColors.push(exSelectColors.slice(i, i + 4));
            }

            for (let i = 0; i < number26; i++) {
                let testTube = { balls: separateExSelectColors[i], element: createTestTubeElement() };
                testTubes.push(testTube);
            }

            addEmptyTestTube(); // æœ€åˆã®ç©ºã®è©¦é¨“ç®¡ã‚’è¿½åŠ 
            
            numAddTestTubes();
                
            moveHistory = [];
            saveState(); // åˆæœŸçŠ¶æ…‹ã‚’ä¿å­˜
                
            renderTestTubes();
        }
        function numAddTestTubes() {
            numAddTestTube = testTubes.length - number26 - 1;
            document.getElementById("text").innerText = `ï¼‹ğŸ§ª ${2 - numAddTestTube}/2æœ¬`;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function createTestTubeElement() {
            let testTubeElement = document.createElement('div');
            testTubeElement.className = 'test-tube';
            testTubeElement.addEventListener('click', () => selectTube(testTubeElement));
            return testTubeElement;
        }

        function addEmptyTestTube() {
            if (numAddTestTube !== 2){
                saveState(); // è¿½åŠ å‰ã®çŠ¶æ…‹ã‚’ä¿å­˜
                let emptyTube = { balls: [], element: createTestTubeElement() };
                testTubes.push(emptyTube);
                numAddTestTubes();
                renderTestTubes();
            } 
        }

        function selectTube(testTubeElement) {
            let testTube = testTubes.find(tube => tube.element === testTubeElement);
            if (!testTube) return;
            if (selectedTube === null) {
                // è©¦é¨“ç®¡ã‚’é¸æŠï¼ˆãƒœãƒ¼ãƒ«ã‚’æŒã¡ä¸Šã’ã‚‹ï¼‰
                if (testTube.balls.length > 0) {
                    selectedTube = testTube;
                    testTube.element.classList.add('selected');
                    // ãƒœãƒ¼ãƒ«ã‚’å°‘ã—æŒã¡ä¸Šã’ã‚‹
                    let balls = testTube.element.querySelectorAll('.ball');
                    if (balls.length > 0) {
                        balls[balls.length - 1].style.bottom = `${parseInt(balls[balls.length - 1].style.bottom) + 30}px`;
                    }
                }
            } else {
                if (selectedTube !== testTube && canMoveBall(selectedTube, testTube)) {
                    saveState(); // ç§»å‹•å‰ã®çŠ¶æ…‹ã‚’ä¿å­˜
                    let ballColor = selectedTube.balls.pop();
                    testTube.balls.push(ballColor);
                    // é¸æŠã‚’è§£é™¤ï¼ˆãƒœãƒ¼ãƒ«ã‚’ä¸‹ã’ã‚‹ï¼‰
                    resetSelection();
                    renderTestTubes();
                    checkWinCondition();
                } else {
                    // é¸æŠè§£é™¤ï¼ˆãƒœãƒ¼ãƒ«ã‚’ä¸‹ã’ã‚‹ï¼‰
                    resetSelection();
                }
            }
        }
        function resetSelection() {
            if (selectedTube) {
                selectedTube.element.classList.remove('selected');
                // ãƒœãƒ¼ãƒ«ã‚’å…ƒã®ä½ç½®ã«æˆ»ã™
                let balls = selectedTube.element.querySelectorAll('.ball');
                if (balls.length > 0) {
                    balls[balls.length - 1].style.bottom = `${parseInt(balls[balls.length - 1].style.bottom) - 30}px`;
                }
            }
            selectedTube = null;
        }


        function saveState() {
            let stateCopy = testTubes.map(tube => ({ balls: [...tube.balls] }));
            moveHistory.push(JSON.stringify(stateCopy)); // æ–‡å­—åˆ—åŒ–ã—ã¦ä¿å­˜
        }

        function undoMove() {
            if (moveHistory.length === 0) return;
            let previousState = JSON.parse(moveHistory.pop()); // æ–‡å­—åˆ—ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æˆ»ã™
            testTubes = previousState.map(tube => ({ balls: tube.balls, element: createTestTubeElement() }));
            numAddTestTubes();
            renderTestTubes();
        }

        function canMoveBall(fromTube, toTube) {
            if (toTube.balls.length === 0) return true;
            let firstBallColor = toTube.balls[toTube.balls.length - 1];
            return firstBallColor === fromTube.balls[fromTube.balls.length - 1] && toTube.balls.length < numBalls;
        }

        function renderTestTubes() {
            document.getElementById('testTubes').innerHTML = '';
            testTubes.forEach(tube => {
                tube.element.innerHTML = '';

                tube.balls.forEach((color, i) => {
                    let ballDiv = document.createElement('div');
                    ballDiv.className = 'ball';
                    ballDiv.style.bottom = `${i * 36 + 10}px`;
                    let ballImg = document.createElement('img');
                    ballImg.src = ballImages[color];
                    ballDiv.appendChild(ballImg);
                    tube.element.appendChild(ballDiv);
                });

                document.getElementById('testTubes').appendChild(tube.element);
            });
        }

        function checkWinCondition() {
            let isWin = testTubes.every(tube => 
                tube.balls.length === 0 || tube.balls.length === 4 && tube.balls.every(color => color === tube.balls[0])
            );
            if (isWin) {setTimeout(() => alert('ï¸ğŸŒŸï¸ğŸŒŸï¸ğŸŒŸï¸ğŸŒŸï¸ğŸŒŸï¸ğŸŒŸï¸ğŸŒŸï¸ğŸŒŸï¸ğŸŒŸ'), 100);}
        }
        function retryGame() {
            if (moveHistory.length === 0) return;
            let previousState = JSON.parse(moveHistory[0]); // æ–‡å­—åˆ—ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æˆ»ã™
            testTubes = previousState.map(tube => ({ balls: tube.balls, element: createTestTubeElement() }));
            numAddTestTubes();
            renderTestTubes();
        }

        function restartGame() { startGame(); }
    
        startGame();
    
        document.getElementById("text").innerText = `ï¼‹ğŸ§ª 2/2æœ¬`;
    </script>
</body>
</html>
